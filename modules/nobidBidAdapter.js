import*as utils from"src/utils";import{registerBidder}from"src/adapters/bidderFactory";const BIDDER_CODE="nobid";window.userSyncPixels=window.userSyncPixels||{},window.nobid=window.nobid||{},nobid.version="1.0.0",nobid.status={},nobid.status.bidResponseProcessed=!1,nobid.status.bidResponseTimeout=3,nobid.topLocation=function(){return window.context&&window.context.location&&window.context.location.href?window.context.location.href:document.location.href},nobid.timestamp=function(){var e=new Date,i=function(e){return e<=9?"0"+e:""+e},n=e.getDate(),t=e.getFullYear(),o=e.getMonth()+1,d=e.getHours(),s=e.getMinutes(),r=e.getSeconds();return t+"-"+i(o)+"-"+i(n)+" "+i(d)+":"+i(s)+":"+i(r)},nobid.clientDim=function(){try{return`${screen.width}x${screen.height}`}catch(e){console.error(e)}},nobid.a=[],nobid.l=encodeURIComponent(nobid.topLocation().replace("%","")),nobid.tt=encodeURIComponent(document.title),nobid.t=nobid.timestamp(),nobid.tz=Math.round((new Date).getTimezoneOffset()),nobid.r=nobid.clientDim(),nobid.log=function(e,i){"function"==typeof utils.getParameterByName&&utils.getParameterByName("nobid-debug")&&(void 0!==i?console.log("NoBid Prebid Adapter: "+e,i):console.log("NoBid Prebid Adapter: "+e))},nobid.location=function(e){nobid.l=encodeURIComponent(e)},nobid.getAdUnit=function(e){for(var i=0;i<nobid.a.length;i++)if(nobid.a[i].d===e)return nobid.a[i];return!1},nobid.triggerEvent=function(e,i){var n="";if(i)for(var t in i)""!=n&&(n+="&"),n+=t+"="+i[t];n="t="+e+"&r="+Math.floor(11e3*Math.random())+"&"+n;var o=document.createElement("script");o.src="//event.servenobid.com/event.js?"+n;var d=document.getElementsByTagName("script")[0];d.parentNode.insertBefore(o,d)},nobid.adunit=function(e){var i=nobid.getAdUnit(e.div)||{};return e.account?i.s=e.account:nobid.s&&(i.s=nobid.s),e.sizes&&(i.z=e.sizes),e.div&&(i.d=e.div),e.targeting?i.g=e.targeting:i.g={},e.companion&&(i.c=e.companion),e.div&&function(e,i,n){for(var t=e.length-1;t>=0;t--){var o=e[t];o[i]&&o[i]===n&&e.splice(t,1)}}(nobid.a,"d",e.div),e.sizeMapping&&(i.sm=e.sizeMapping),e.rtb&&(i.rtb=e.rtb),nobid.a.push(i),i},nobid.siteId=function(e){nobid.site=e},nobid.setup=function(e,i){for(var n=[],t=0;t<i.length;t++){var o=i[t],d=o.adUnitCode;n.push(d);var s=o.sizes;o.params&&o.params.tags?nobid.adunit({div:d,sizes:s,rtb:o.params.tags}):nobid.adunit({div:d,sizes:s})}return pbjs.bidderSettings&&pbjs.bidderSettings.nobid&&pbjs.bidderSettings.nobid.location&&nobid.location(pbjs.bidderSettings.nobid.location),function(e,i){var n={};return e&&(nobid.f=1),n.f=nobid.f,n.sid=nobid.site,n.s=nobid.s,n.g=nobid.g,n.l=nobid.l,n.tt=nobid.tt,n.tt=n.tt.replace(/'|;|quot;|39;|&amp;|&|#|\r\n|\r|\n|\t|\f|\%0A|\"|\%22|\%5C|\%23|\%26|\%26|\%09/gm,""),n.rtb=nobid.rtb,n.a=function(e,i){var n=[];if(e&&e.length){if(i){var t=[];e instanceof Array?t=e:t.push(e);for(var o=0,d=i.length;o<d;o++){var s=i[o];s&&s.d&&t.indexOf(s.d)>-1&&n.push(s)}}}else n=i;return n}(i,nobid.a||[]),n.t=nobid.timestamp(),n.tz=Math.round((new Date).getTimezoneOffset()),n.r=nobid.clientDim(),n}(e,n)},nobid.ProcessBidResponse=function(e,i){var n=[];nobid.status.bidResponseProcessed=!0,nobid.status.bidResponseTimeout=!1,nobid.status.bidResponse=e;for(var t=0;void 0!==e&&e&&e.bids&&t<e.bids.length;t++){var o=e.bids[t];if(o.bdrid<100||!i||!i.bidderRequest||!i.bidderRequest.bids)continue;var d=i.bidderRequest.bids.find(e=>e.adUnitCode==o.divid);if(!d)continue;const s={requestId:d.bidId,cpm:1*(o.bucket?o.bucket:o.price),width:o.size.w,height:o.size.h,creativeId:o.creativeid||"",dealId:o.dealid||"",currency:"USD",netRevenue:!0,ttl:300,ad:o.adm,mediaType:"banner"};n.push(s)}return n},nobid.renderTag=function(e,i){if(nobid.log("-NoBid Prebid Adapter- nobid.renderTag()",i),nobid.bidResponse&&nobid.bidResponse.bids)for(var n in nobid.bidResponse.bids){const o=nobid.bidResponse.bids[n];if(i==o.id&&o.adm2){nobid.log("-NoBid Prebid Adapter- nobid.renderTag() found tag",i);var t=o.adm2;e.write(t),e.close();break}}},nobid.cookies={},nobid.cookies.get=function(e){var i=("; "+document.cookie).split("; "+e+"=");if(2===i.length)return i.pop().split(";").shift()},nobid.cookies.getAll=function(){return document.cookie.split("; ").reduce(function(e,i){var n=i.indexOf("=");return e[i.substr(0,n)]=i.substr(n+1),e},{})},nobid.cookies.set=function(e,i,n){var t=new Date;t.setTime(t.getTime()+1e3*n);var o="expires="+t.toUTCString();document.cookie=e+"="+i+";"+o+";path=/"},userSyncPixels._cookiesMap=nobid.cookies.getAll(),userSyncPixels.create=function(e,i,n,t){userSyncPixels._cookiesMap["usp."+e]||!!(i=""===i||0===i.indexOf("$")?[]:i.split("|")).find(function(e){return-1!==document.location.hostname.indexOf(e)})===n&&t();nobid.cookies.set("usp."+e,1,86400),userSyncPixels._cookiesMap["usp."+e]=1},userSyncPixels.init=function(){if(document.body){var e=document.createElement("span"),i=Math.floor(11e3*Math.random());e.style.display="none";var n=document.createElement("iframe");n.style.display="none",n.src="https://s3.amazonaws.com/nobid-public/sync.html?cb="+i,e.appendChild(n),document.body.appendChild(e)}return n};export const spec={code:"nobid",isBidRequestValid:function(e){return nobid.log("-NoBid Prebid Adapter- isBidRequestValid",e),!0},buildRequests:function(e,i){if(nobid.log("-NoBid Prebid Adapter- buildRequests",e),!pbjs.bidderSettings.nobid.siteId)return;nobid.siteId(pbjs.bidderSettings.nobid.siteId);const n=nobid.setup(!1,e),t=JSON.stringify(n).replace(/'|&|#/g,"");var o,d;return{method:"POST",url:(o="https://ads.servenobid.com/",(d="function"==typeof utils.getParameterByName&&utils.getParameterByName("nobid-env"))?"beta"==d?o="https://beta.servenobid.com/":"dev"==d?o="//localhost:8282/":"qa"==d&&(o="https://qa-ads.nobid.com/"):o="https://ads.servenobid.com/",o=o+"adreq?r="+Math.floor(11e3*Math.random())),data:t,bidderRequest:i}},interpretResponse:function(e,i){return nobid.log("-NoBid Prebid Adapter- interpretResponse",e),nobid.log("-NoBid Prebid Adapter- interpretResponse",i),nobid.bidResponse=e.body,nobid.ProcessBidResponse(e.body,i)},getUserSyncs:function(e,i){return[]},onTimeout:function(e){nobid.log("-NoBid Prebid Adapter- onTimeout",e),nobid.status.bidResponseTimeout=!0}};registerBidder(spec);